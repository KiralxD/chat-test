<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="css/chatbot.css" type="text/css" />
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js" type="text/javascript"></script>
  <link rel="icon" type="image/ico" href="img/favicon.ico"/>
  <meta charset="utf-8" />
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="pragma" content="no-cache" />
  <title>Chatbot</title>

</head>

<body>
  <nav class="navbar navbar-expand-sm bg-info">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link text-white" href="#">
          <span class="dot"></span>&nbsp;Chatbot está online
        </a>
      </li>
    </ul>
  </nav>
  <br />

    <!--CONTENT CHATBOT-->
  <div>
    <div style="overflow-y:scroll; height: 300px; width: 100%;" align="center" id="msg">
      <div class="talk-bubble tri-right left-top" style="width: 90%; color:#808080; background-color: #eeeeee;">
        <div class="talktext">

          <img src="https://user-images.githubusercontent.com/67064886/93029635-c5f0ba00-f5f2-11ea-835c-bcefbee941fc.png" alt="" width="45" height="45" />
             Olá! Em que posso ajudar?
        </div>
      </div>
    </div>
    <input type="text" id="input" class="form-control" onkeypress="return Send(event)"
      placeholder="Digite a sua mensagem e tecle Enter..." />
  </div>
  <input type="hidden" id="code_user" value="[code_user]" />
  <input type="hidden" id="code_before" value="0" />

 <!--CONTENT CHATBOT-->

  <script type="text/javascript">
    function Send(e) {
      if (e.keyCode == 13) {
        perguntar()
        return false
      }
    }

    function perguntar() {
      const Input = document.getElementById('input')
      const question = Input.value.toString().trim()

      const msg = document.getElementById('msg')
      const code_user = document.getElementById('code_user')
      const code_before = document.getElementById('code_before')

      let msgLines = msg.innerHTML
      msgLines = msgLines.replace('<a href="#" id="end">', '')
      const codeUser = Number(code_user.value)
      const codeBefore = Number(code_before.value)

      const http = new XMLHttpRequest()
      http.open(
        'GET',
        `/chatbot/question?code_user=${codeUser}&code_before=${codeBefore}&input=${question}`,
        true
      )
      http.setRequestHeader(
        'Content-Type',
        'application/x-www-form-urlencoded'
      )

      http.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
          let objJSON = JSON.parse(http.responseText)
          if (objJSON.length > 0) {
            code_before.value = objJSON[0].code_current

            const input = objJSON[0].input.toString().trim()
            const output = objJSON[0].output.toString().trim()


            let speech = new SpeechSynthesisUtterance(output)

            speech.lang = 'pt-PT'
            window.speechSynthesis.speak(speech)


            msgLines += `
							<div class="talk-bubble tri-right right-top" 
							     style="width: 70%; margin-right: 20px; background-color: #3fb9fe;">
							  <div class="talktext">
							    <p>${input}</p>
							  </div>
							</div>
   
              
							<div class="talk-bubble tri-right left-top" 
							     style="width: 90%; color: #808080; background-color: #eeeeee;">
                <div class="talktext">
                  <img src="https://user-images.githubusercontent.com/67064886/93029635-c5f0ba00-f5f2-11ea-835c-bcefbee941fc.png" alt="" width="42" height="42">
							       ${output}
							  </div>
							</div>

							<a href="#" id="end">
	   						`
            document.getElementById('input').value = ''
            msg.innerHTML = msgLines
            window.location.href = '#end'
            document.getElementById('input').focus()
          }
        }
      }
      http.send()
    }
    window.location.href = '#end'
  </script>
</body>

</html>